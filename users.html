<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Qu·∫£n l√Ω ng∆∞·ªùi d√πng & ph√¢n quy·ªÅn</title>

    <!-- Bootstrap 5 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>

    <style>
        body {
            background-color: #f5f6fa;
        }
        .card {
            border-radius: 12px;
        }
    </style>
</head>
<body>

<div class="container mt-4">
    <div class="card shadow">
        <div class="card-header bg-primary text-white">
            üë§ Qu·∫£n l√Ω ng∆∞·ªùi d√πng & ph√¢n quy·ªÅn
        </div>

        <div class="card-body">
            <button class="btn btn-success mb-3" id="btnAdd">
                ‚ûï Th√™m ng∆∞·ªùi d√πng
            </button>

            <table class="table table-bordered table-hover">
                <thead class="table-dark">
                <tr>
                    <th>Username</th>
                    <th>H·ªç t√™n</th>
                    <th>Quy·ªÅn</th>
                    <th>Tr·∫°ng th√°i</th>
                    <th width="160">Ch·ª©c nƒÉng</th>
                </tr>
                </thead>
                <tbody id="userTable">
                
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- MODAL -->
<div class="modal fade" id="userModal">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">Th√¥ng tin ng∆∞·ªùi d√πng</h5>
                <button class="btn-close" data-bs-dismiss="modal"></button>
            </div>

            <div class="modal-body">
                <div class="mb-2">
                    <label>Username</label>
                    <input type="text" id="username" class="form-control">
                </div>
                <div class="mb-2">
                    <label>M·∫≠t kh·∫©u</label>
                    <input type="password" id="password" class="form-control">
                </div>
                <div class="mb-2">
                    <label>H·ªç t√™n</label>
                    <input type="text" id="fullname" class="form-control">
                </div>
                <div class="mb-2">
                    <label>Quy·ªÅn</label>
                    <select id="role" class="form-select">
                        <option value="Admin">Admin</option>
                        <option value="Nh√¢n vi√™n">Nh√¢n vi√™n</option>
                    </select>
                </div>
                <div class="mb-2">
                    <label>Tr·∫°ng th√°i</label>
                    <select id="status" class="form-select">
                        <option value="1">Ho·∫°t ƒë·ªông</option>
                        <option value="0">Kh√≥a</option>
                    </select>
                </div>
            </div>

            <div class="modal-footer">
                <button class="btn btn-primary" id="btnSave">L∆∞u</button>
                <button class="btn btn-secondary" data-bs-dismiss="modal">ƒê√≥ng</button>
            </div>
        </div>
    </div>
</div>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
    function loadUsers() {
    $.getJSON("api/user_list.php", function (data) {
        let html = "";

        $.each(data, function (i, user) {
            let statusHtml = user.status == 1
                ? '<span class="badge bg-success">Ho·∫°t ƒë·ªông</span>'
                : '<span class="badge bg-secondary">Kh√≥a</span>';

            html += `
            <tr data-id="${user.user_id}">
                <td>${user.username}</td>
                <td>${user.full_name}</td>
                <td>${user.role_name}</td>
                <td>${statusHtml}</td>
                <td>
                    <button class="btn btn-warning btn-sm btnEdit">S·ª≠a</button>
                    <button class="btn btn-danger btn-sm btnDelete">X√≥a</button>
                </td>
            </tr>`;
        });

        $("#userTable").html(html);
    });
}
$(document).ready(function () {
    loadUsers();
});
let currentRow = null;
let currentUserId = null;

/* =========================
   TH√äM NG∆Ø·ªúI D√ôNG
========================= */
$("#btnAdd").click(function () {
    currentRow = null;
    currentUserId = null;

    $("#username").prop("disabled", false).val("");
    $("#password").val("");
    $("#fullname").val("");
    $("#role").val("Nh√¢n vi√™n");
    $("#status").val(1);

    $("#userModal").modal("show");
});

/* =========================
   S·ª¨A NG∆Ø·ªúI D√ôNG
========================= */
$(document).on("click", ".btnEdit", function () {
    currentRow = $(this).closest("tr");
    currentUserId = currentRow.data("id"); // l·∫•y user_id

    $("#username").val(currentRow.find("td:eq(0)").text())
                  .prop("disabled", true);

    $("#fullname").val(currentRow.find("td:eq(1)").text());
    $("#role").val(currentRow.find("td:eq(2)").text());

    let statusText = currentRow.find("td:eq(3)").text().trim();
    $("#status").val(statusText === "Ho·∫°t ƒë·ªông" ? 1 : 0);

    $("#password").val(""); // kh√¥ng s·ª≠a m·∫≠t kh·∫©u ·ªü ƒë√¢y
    $("#userModal").modal("show");
});

/* =========================
   L∆ØU (TH√äM / S·ª¨A)
========================= */
$("#btnSave").click(function () {
    let data = {
        username: $("#username").val(),
        password: $("#password").val(),
        fullname: $("#fullname").val(),
        role_id: $("#role").val() === "Admin" ? 1 : 2,
        status: $("#status").val()
    };

    // TH√äM
    if (currentUserId === null) {
        $.post("api/user_add.php", data, function (res) {
            alert("Th√™m ng∆∞·ªùi d√πng th√†nh c√¥ng");
            location.reload();
        }, "json");

    // S·ª¨A
    } else {
        data.user_id = currentUserId;

        $.post("api/user_update.php", data, function (res) {
            alert("C·∫≠p nh·∫≠t th√†nh c√¥ng");
            location.reload();
        }, "json");
    }
});

/* =========================
   X√ìA NG∆Ø·ªúI D√ôNG
========================= */
$(document).on("click", ".btnDelete", function () {
    if (!confirm("B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a ng∆∞·ªùi d√πng n√†y?")) return;

    let row = $(this).closest("tr");
    let userId = row.data("id");

    $.post("api/user_delete.php", { user_id: userId }, function (res) {
        row.remove();
    }, "json");
});
</script>

</body>
</html>
